#!/bin/bash
#SBATCH --job-name=osiris_batch
#SBATCH --account=f202500196cpcaa3a
#SBATCH --partition=normal-arm
#SBATCH --time=0-00:01:00
#SBATCH --ntasks=54                 # 6*Boris(8) + 3*Gca(1) + 3*GcaCorr(1) = 48+3+3
#SBATCH --cpus-per-task=1
#SBATCH --threads-per-core=1
#SBATCH --mem-per-cpu=2G            # adjust if your runs need more
#SBATCH --output=job.%j.out
#SBATCH --error=job.%j.err
#SBATCH --kill-on-invalid-dep=yes

module purge
module load OpenMPI
ml HDF5/1.12.2-gompi-2022a
module load FFTW

# Paths
BIN=/../../../osiris_JCDev/bin/osiris-3D-deucalion_input_disable_gca_gcaCorr.e

# For safety: 1 OpenMP thread per rank
export OMP_NUM_THREADS=1
export OMP_PROC_BIND=close
export OMP_PLACES=cores

# helper to launch one sim
run_sim () {
  local ntasks="$1" dir="$2" infile="$3" tag="$4"
  srun -n "${ntasks}" --exclusive \
       bash -lc "cd '${dir}' && echo '[$tag] $(pwd)' && '${BIN}' '${infile}' > ${tag}.out 2> ${tag}.err"
}

# --- Launch all 9 runs concurrently ---
# Boris (8 ranks each)
run_sim 8 "/Boris/dtw0_01"  "Boris.in"   "Boris_dtw0_01"    &
run_sim 8 "/Boris/dtw0_1"   "Boris.in"   "Boris_dtw0_1"     &
run_sim 8 "/Boris/dtw1"     "Boris.in"   "Boris_dtw1"       &
run_sim 8 "/Boris/dtw10"    "Boris.in"   "Boris_dtw10"      &
run_sim 8 "/Boris/dtw100"   "Boris.in"   "Boris_dtw100"     &
run_sim 8 "/Boris/dtw1000"  "Boris.in"   "Boris_dtw1000"    &

# Gca (1 rank each)
run_sim 1 "/Gca/dtw10"     "Gca.in"     "Gca_dtw10"     &
run_sim 1 "/Gca/dtw100"    "Gca.in"     "Gca_dtw100"    &
run_sim 1 "/Gca/dtw1000"   "Gca.in"     "Gca_dtw1000"   &

# GcaCorr (1 rank each)
run_sim 1 "/GcaCorr/dtw10"   "GcaCorr.in" "GcaCorr_dtw10"   &
run_sim 1 "/GcaCorr/dtw100"  "GcaCorr.in" "GcaCorr_dtw100"  &
run_sim 1 "/GcaCorr/dtw1000" "GcaCorr.in" "GcaCorr_dtw1000" &

# Wait for all to finish; if any srun fails, fail the job
wait
